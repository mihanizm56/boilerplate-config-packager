# Инструкция по деплою

Для начала здесь (http://api.deploy-service.svc.k8s.datapro) надо получить доступ, его выдаст Александр Черников `@Vladimir_Kleusov`<br>
Затем надо написать `@abernod137`, чтобы он выдал доступы. В сообщении можете приложить скрины ниже, 
чтобы было понятно, какой именно доступ тебе нужен.<br>
Скрины ошибок если нет доступа:<br>
![](_assets/deploy/access-error-1.png)
или такой
![](_assets/deploy/access-error-2.jpg)

## Настройка deploy-service

Не забывай нажимать кнопку `Save changes` каждый раз

#### Создание проекта

После того как получишь логин и пароль для входа, создаешь проект как названа твоя репа
**Без заглавных букв! Например твоя репа называется `Service-Desk-front` надо назвать проект `service-desk-front`**
![](_assets/deploy/add-project.png)
<br>
<br>
и генерируешь ключ
![](_assets/deploy/generate-token.png)
<br>
<br>

#### Создание кластера

Создаешь кластер `k8s.test`, копируешь все настройки с любого другого такого же кластера
![](_assets/deploy/cluster-settings.png)
<br>
<br>
Обрати внимание, это не заполняется, тут надо опять написать Черникову, чтобы он нажал на кнопку Generate
![](_assets/deploy/btn-generate.png)
<br>
<br>
Также обрати внимание здесь. Тут от кластера к кластеру конфиг может отличатся, тут 8 команд, но может быть 9 (например в `k8s.stage`)
![](_assets/deploy/plugin-configurations.png)
<br>
<br>

#### Зависимости

Теперь насчет зависимостей: <br>
У тебя для деплоя есть 4 кластера:

1.  test — для стадии тестов
2.  stage — для стадии тестов
3.  datapro — для продакшена
4.  dataline — для продакшена

`stage` зависит от `test` , поэтому в этом кластере стейджа мы указываем название `test` кластера.<br>
![](_assets/deploy/dependencies.png)
<br>
<br>
`datapro` зависит от stage<br>
`dataline` зависит от stage<br>
<br>
<br>

#### Регулярки

- test –– `^v\d+\.\d+\.\d+-test(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- stage –– `^v\d+\.\d+\.\d+-stage(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- dataline –– `^v\d+\.\d+\.\d+-dataline(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- datapro –– `^v\d+\.\d+\.\d+-datapro(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`

<br>
<br>

## Настройка репозитория

**Не забудь, что выкатываем на какой бы то ни было стенд(test, stage, dataline, datapro)
только с ветки `release/<версия>` например, `release/1.0` (подробнее об этом ниже в разделе FAQ)**
<br>
Запускаем npm run setup
Получаем в окошке терминала опросник, который задает нам переменные в файле .env
(рядом с каждым из вопросов отображается за какую переменную данный вопрос отвечает)
![](_assets/deploy/setup-envs-questions.png)
<br>
<br>

### –– Какие переменные за что отвечают

#### –– Обычная модификация

<b>REACT_APP_ROUTER_PREFIX</b> - префикс первого роута приложения (если он один то должен заканчиваться на /)
<br>
<b>DEPLOY_TOKEN</b> - токен деплоя от админки ci-cd
<br>
<b>REPO_NAME</b> - название репозитория (также как и нэймспейса в админке ci-cd)
<br>
<b>SERVER_PORT</b> - порт на котором поднимается сервер статики
<br>
<b>IP_LIMIT</b> - количество допустимых запросов в минуту с одного ip
<br>
<b>BROWSER</b> - настройка create-react-app для автозапуска браузера при старте приложения
<br>
<b>PUBLIC_URL</b> - префикс для сборки статических файлов
<br>

#### –– Модификация --euro (европортал)

<b>REACT_APP_ROUTER_PREFIX</b> - префикс первого роута приложения, начинается с / (если он один то НЕ должен заканчиваться на /)
<br>
<b>PROJECT_NAME</b> - название проекта (НЕ также как и нэймспейса в админке ci-cd, а как название для подключения в меню платформы - узнать название у ответственных за платформу)
<br>
<b>DEPLOY_TOKEN</b> - токен деплоя от админки ci-cd
<br>
<b>REPO_NAME</b> - название репозитория (также как и нэймспейса в админке ci-cd)
<br>
<b>BROWSER</b> - настройка create-react-app для автозапуска браузера при старте приложения
<br>
<br>

Далее вводим свои переменные для эндпоинтов (Для обычной модификации "не евро" помимо урлов для запросов нужны переменные SERVER_PORT, IP_LIMIT) в файлах:
<br>
`config/deploy/template_ci.sh (во всех местах где встречается секция env)`
![](_assets/deploy/setup-envs-sh.png)
<br>

Вводим свои переменные для эндпоинтов (в евро нет)
`config/deploy/frontend-envs.js`
<br>
![](_assets/deploy/setup-envs-js.png)

Вводим свои переменные для эндпоинтов (в евро нет)
`src/react-app-env.d.ts`
<br>
![](_assets/deploy/setup-envs-d-ts.png)

Далее выбираем команду для деплоя из списка (промежуток между закидыванием тагов 250 секунд для решения проблемы последовательных деплоев на стенды)
<br>
![](_assets/deploy/deploy-menu.png)
<br>
<br>

В админке деплой сервиса должны появится твои теги:
<br>
![](_assets/deploy/success_admin.png)
<br>
<br>

## Примеры

#### –– Обычная модификация

https://git.wildberries.ru/portals/suppliers-multiplicity-front

#### –– Модификация --euro (европортал)

https://git.wildberries.ru/infrastructure/suppliers-portal-eu-registration

## FAQ

#### –– Как мне правильно работать с ветками (release, develop)?

Для начала стоит железно запомнить, что **любой** деплой, будь то просто протестить как фронт будет выглядеть
вместе с "оболочкой" или выкатиться на продакшен, **ты запускаешь `скрипт-для-деплоя` только находясь на ветке `release/<версия>`**
<br>
Теперь подробнее остановимся на возможных кейсах:<br>
**Фронт готов, тебе надо выкатится и потестить** –– в этом случае твои шаги:

- создаешь `release/1.0` ветку из `develop`
- делаешь чекаут на нее
- из нее запускаешь скрипт-для-деплоя

**Фронт НЕ готов, но ты хочешь потестить/посмотреть** –– в этом случае твои шаги:

- создаешь `release/1.0` ветку из `develop`
- делаешь чекаут на нее
- из нее запускаешь скрипт-для-деплоя
- удаляешь ветку `release/1.0`, после того как потестил, что тебе требовалось

**У тебя уже есть ветка `release`, но ты нашел баги и хочешь их пофиксить** –– в этом случае твои шаги:

- создаешь ветку hotfix/<название-фикса> из `release`
- фиксишь в ней свои баги
- создаешь 2 МР'а в ветки `release` и `develop`
- после того как твой фикс замержат в обе ветки ты заходишь на ветку `release`
- из нее запускаешь скрипт-для-деплоя

**У тебя уже есть ветка `release`, ты исправил все баги, теперь тебе надо релизить на продакшен стенд** –– в этом случае твои шаги:

- удостоверься, что ветки `release` и `develop` абсолютно идентичны
- делаешь чекаут на нее
- из нее запускаешь скрипт-для-деплоя

**У тебя уже есть ветка `release`, но требуется добавить новый функционал** –– в этом случае твои шаги:

- удостоверься, что ветки `release` и `develop` абсолютно идентичны
- создавай новую ветку `release`, инкрементируя версию (было `release/1.0` стало `release/1.1`)
- делаешь чекаут на нее
- из нее запускаешь скрипт-для-деплоя

#### –– Если я залил изменения в ветку надо ли делать тег заново?

Да, если ты изменил и залил, то это соответственно уже другой коммит.
Очень важно чтобы **ВСЕ** теги были созданы из одного и того же коммита.<br>
Иначе просто не поднимутся все кластеры кроме теста. <br>
<br>
<br>
#### –– У меня тег упал, что делать?
1) Для начала проверь запустились ли твои теги в правильном порядке. То есть тест тег мог еще не задеплоится, а стейдж 
уже начал выполнятся. Иногда есть вероятность, что 200миллисек не хватает между деплоями тегов. Зайди в ci-cd гитлаба
и проверь пайплайны, если проблема действительно в этом, просто рестартни пайплайны в правильном порядке.
2) Если теги запустились правильно, но все равно есть какая-то ошибка, то **не пытайся перезапустить один и тот же тег**. 
Для начала исправь проблему, которая могла привести к падению тега, затем снова запускай теги. 
Например: тег `v0.0.4-test-5` задеплоился на деплой-сервис, но не работает. Ты не удаляешь этот тег и создаешь 
такой же, а **инкрементируешь версию** (`v0.0.5-test-1`) и запускаешь новый тег. <br>
То есть если в админке уже есть тег во вкладке Information, то не надо пытаться перезапустить его, просто сделай новый тег.

#### –– В каком порядке создавать теги (если делать всё самому, без скрипта-для-деплоя)?

Теги создаются в порядке:
<br>
`test` ––> `stage` ––> `dataline`, `datapro` (два последних можно запустить параллельно)
<br>
<br>

#### –– Когда какие теги и кластеры создавать?

- `test` –– когда нужно протестировать фронт, если после разработки впервые надо выкатить фронт, достаточно только этого тега(и кластера соответственно). Также подходит для интеграции в "оболочку", но бекендеры для этой цели просят именно `stage`.
- `stage` –– когда бекендеру нужно интегрировать твой фронт в так называемую "оболочку", перед запуском этого тега необходим уже запущенный `test` тэг. `stage` тэг запускаешь соответственно с того же коммита, с которого запускал `test` тег
- `dataline` и `datapro` –– когда всё готово к тому, чтобы выкатывать на продакшен, перед запуском этих тегов требуются `test` и `stage` тэги (получается, что при выкатке на прод надо по-новому создать все теги, из ветки `release/<версия>`). Запускать `dataline` и `datapro` можно параллельно. Запускаешь соответственно с того же коммита, с которого запускал `test` и `stage` теги

#### –– По какой ссылке посмотреть мой фронт?

Дальше теги проходят пайплайны, (пайплайн release, который мы настраивали в
файле `.gitlab-ci.yml` должен пройти) на деплой сервисе происходит магия
(надо подождать минут 2-3 (если не `test` стенд)
если не поднялось на стенде то надо идти спрашивать у Димы Краснова) и все,
твой фронт будет доступен по адресу:
<br>`http://front.<namespace>.svc.k8s.<название-кластера>`<br>
поскольку мы выбрали в качестве неймспейса название репы, то ее и указываем,<br>
например: http://front.supplementary-documents-admin-front.svc.k8s.stage
