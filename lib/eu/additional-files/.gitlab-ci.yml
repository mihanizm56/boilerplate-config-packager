image: node:12.13

variables:
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_TLS_CERTDIR: ''

stages:
  - install_dependencies
  - tests_bundle
  - integration_tests
  - build_module
  - release

install_dependencies:
  tags:
    - linux
  stage: install_dependencies
  script:
    - npm install
  artifacts:
    paths:
      - node_modules/
  retry:
    max: 2

lint:
  tags:
    - linux
  stage: tests_bundle
  script:
    - node ./cli/_utils/ci-utils/executor.js --command=lint-full
  retry:
    max: 2

test:
  tags:
    - linux
  stage: tests_bundle
  script:
    - node ./cli/_utils/ci-utils/executor.js --command=test
  retry:
    max: 2

build:
  tags:
    - linux
  stage: tests_bundle
  script:
    - node ./cli/_utils/ci-utils/executor.js --command=cra-build
  artifacts:
    paths:
      - build/
  retry:
    max: 2

integration-tests:
  tags:
    - baremetal-linux
  stage: integration_tests
  image: circleci/node:12.13-browsers
  script:
    - node ./cli/_utils/ci-utils/executor.js --command=integration-tests
  retry:
    max: 2

build_release:
  tags:
    - linux
  stage: build_module
  script:
    - node ./cli/_utils/ci-utils/executor.js --command=module-build
  artifacts:
    paths:
      - build/
  retry:
    max: 2

release:
  tags:
    - linux
  stage: release
  image: git.wildberries.ru:4567/infrastructure/deploy-service/deploy-service/client:release-v1-stable
  services:
    - docker:dind
  only:
    - tags
    - /^v\d+\.\d+\.\d+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$/
  except:
    - branches
  script:
    - apk add --no-cache make docker
    - echo "Release version $CI_COMMIT_TAG"
    - export DEBUG=true
    - deploy-service-client -c deploy-service-client.conf.yaml
